/*! Honey.js by Adam Timberlake created on 2013-06-25 */
window.Honey||(Honey={}),Honey.Collection={modelMapper:{},create:function(a,b,c){var d=[];a.forEach(function(a){var b=this.modelId();a.model=b,this.modelMapper[b]=a,d.push(a)},this);var e=this.getCollectionClass(d),f=new e;return f._dimensions={},f._crossfilter=crossfilter(f),f._collectionClass=d,f._controllerClass=c,f._collectionName=b,f},getCollectionClass:function(a){function b(){return a.__proto__=b.prototype,a}return b.prototype=[],b.prototype.add=Honey.Collection.Methods.add,b.prototype.remove=Honey.Collection.Methods.remove,b.prototype.sort=Honey.Collection.Methods.sort,b.prototype.filter=Honey.Collection.Methods.filter,b.prototype.removeFilter=Honey.Collection.Methods.removeFilter,b.prototype.createDimension=Honey.Collection.Methods.createDimension,b.prototype._applyChanges=Honey.Collection.Methods._applyChanges,b},modelId:function(){var a,b=Math.round(1e4*Math.random()),c=Math.round(1e4*Math.random());do a=[].concat(b,(new Date).getTime(),c).join("-");while(Honey.Collection.modelMapper[a]);return a},Methods:{add:function(a){var b=Honey.Collection.modelId();return a.model=b,Honey.Collection.modelMapper[b]=a,this._collectionClass.push(a),this._controllerClass.view.render(),a},remove:function(a){var b=this._collectionClass;for(var c in b)b.hasOwnProperty(c)&&b[c].model&&b[c].model===a.model&&b.splice(c,1);return this._controllerClass.view.render(),a},createDimension:function(a,b,c){var d=this._dimensions[b];if(d){if(!c)return!0;d.delete()}return this._dimensions[b]=this._crossfilter.dimension(function(a){return a[b]}),!0},filter:function(a,b){var c=this._collectionClass,d=this._controllerClass;c.createDimension.apply(c,[c,a]);var e=c._dimensions[a];e.filterFunction(function(a){return b.call(c,a)});var f=e.top(1/0);return this._applyChanges(f),d.view.render(),f},removeFilter:function(a){var b=this._collectionClass,c=this._controllerClass,d=b._dimensions[a];return d.filterAll(),this._applyChanges(d.top(1/0)),c.view.render(),d},sort:function(a,b){var c=this._collectionClass,d=this._controllerClass,e=crossfilter.quicksort.by(function(b){return b[a]}),f=e(c,0,c.length);return b||(f=f.reverse()),this._applyChanges(f),d.view.render(),f},_applyChanges:function(a){var b=[0,this._collectionClass.length].concat(a);Array.prototype.splice.apply(this._collectionClass,b)}}},Honey.Controller={extend:function(a){var b=function(){var b=this;this.buffer={};var c=function(a){b.propagateChanges.call(b,this,a)},d=function(){return b.view?b.view[this]:b.buffer[this]};for(var e in a)a.hasOwnProperty(e)&&(Array.isArray(a[e])&&(a[e]=Honey.Collection.create(a[e],e,b)),Object.defineProperty(this,e,{set:c.bind(e),get:d.bind(e)}),this[e]=a[e]);Object.defineProperty(this,"_view",{set:function(a){b.attachedView.call(b,a)}})};return b.prototype=Honey.Controller.Methods,b.prototype.controllers=Honey.Factory._controllers,b},Methods:{invokeConstructor:function(){"function"==typeof this.constructor&&this.constructor()},propagateChanges:function(a,b){return this.view?(this.view[a]=b,this.view.render(),this.view):(this.buffer[a.valueOf()]=b,this.buffer)},attachedView:function(a){this.view=a;for(var b in this.buffer)this.buffer.hasOwnProperty(b)&&(this[b]=this.buffer[b]);delete this.buffer}}};var Honey={create:function(a){return new Honey.Application(a||!1)},assert:function(a,b){if(!b)throw new Error("Hey! "+a+", honey.")},Application:function(){document.addEventListener("DOMContentLoaded",Honey.Bootstrap.bind(this),!1)},Bootstrap:function(a){var b=a instanceof Honey.Application,c=b?a:this,d=function(a){return a.match(new RegExp(/([A-Z]{1}[a-z]+)$/g))[0].toLowerCase()},e=function(a){var c,e=[];for(var f in a){var g;if(a.hasOwnProperty(f))if("view"!==d(f)||b)e.push({Class:a[f],name:f,ancestors:0});else{var h=Honey.Utils.getTemplateName(f).toLowerCase(),i=document.querySelector('[data-template-name="'+h+'"]'),j=document.evaluate("ancestor::*",i),k=0;do c=j.iterateNext(),k++;while(c);g={Class:a[f],name:f,ancestors:k},e.push(g)}}return e.sort(function(a,b){return b.ancestors-a.ancestors})},f=e(c);for(var g in f)if(f.hasOwnProperty(g)){var h=f[g];switch(d(h.name)){case"controller":Honey.Factory.createController(h);break;case"view":Honey.Factory.createView(h)}}var i=Honey.Factory.getViews();for(var j in i)if(i.hasOwnProperty(j)){var k=Honey.Factory.getView(j);k.renderable=!0,k.render()}}};Honey.Factory={_controllers:{},_views:{},getControllers:function(){return this._controllers},getViews:function(){return this._views},getController:function(a){return this._controllers[Honey.Utils.getTemplateName(a)]},getView:function(a){return this._views[a]},createView:function(a){var b,c,d=a.Class,e=a.name;return b=new d,b.name=e,b.toString=function(){return"[view "+e+"]"},this._views[e]=b,b.invokeConstructor(),c=Honey.Factory.getController(Honey.Utils.getControllerByView(e)),c&&(c._view=b,b.controller=c),b},createController:function(a){var b,c,d=a.Class,e=a.name;return c=new d,c.name=e,c.toString=function(){return"[controller "+e+"]"},this._controllers[Honey.Utils.getTemplateName(e)]=c,c.invokeConstructor(),b=Honey.Factory.getView(Honey.Utils.getViewByController(e)),b&&(b.controller=c,c._view=b),c}},Honey.Utils={getControllerByView:function(a){return a.replace(/View/,"Controller")},getViewByController:function(a){return a.replace(/Controller/,"View")},getTemplateName:function(a){return a.match(new RegExp(/^([A-Z]{1}[a-z]+)/g))[0].toLowerCase()},getControllerByTemplateName:function(a){var b=a.charAt(0).toUpperCase()+a.slice(1);return b+"Controller"}},Honey.View={templates:{},extend:function(a){var b=function(){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this.renderable=!1};return b.prototype=Honey.View.Methods,b},Methods:{template:null,invokeConstructor:function(){"function"==typeof this.constructor&&this.constructor()},constructor:function(){var a=Honey.Utils.getTemplateName(this.name),b=document.querySelector('[data-template-name="'+a+'"]'),c=function(a,b){var c=b.target.getAttribute("data-"+a),d=b.target.getAttribute("data-model")||null;if(c){var e=document.evaluate("ancestor-or-self::section[@data-template-name]",b.target).iterateNext(),f=e.getAttribute("data-template-name"),g=Honey.Utils.getControllerByTemplateName(f),h=Honey.Factory.getController(g);Honey.assert("You must specify the `"+c+"` event on the `"+g+"`",!!h[c]),h[c].apply(h,[b,Honey.Collection.modelMapper[d]])}};if(b){var d=["click","dblclick","mouseover","mouseleave"];Honey.Factory.getController("ApplicationController"),console.log(Honey.Factory.getControllers()),d.forEach(function(a){b.addEventListener(a,function(b){c(a,b)})})}},render:function(a){if(this.renderable){var b=Honey.Utils.getTemplateName(this.name),c=document.querySelector('[data-template-name="'+b+'"]');if(!this.template&&c){var d,e=document.evaluate("section",c),f=[];do d=e.iterateNext(),d&&f.push(d);while(d);f.forEach(function(a){var b=a.getAttribute("data-template-name");a.innerHTML="{{{"+b+"Template}}}"}),this.template=document.querySelector('[data-template-name="'+b+'"]').innerHTML}var g=this,h=Honey.View.templates;for(var i in h)h.hasOwnProperty(i)&&(g[i]=h[i]);Honey.assert("You must include `Mustache` to be able to render the views",!!window.Mustache);var j=Mustache.render(this.template||a,g);return Honey.View.templates[b+"Template"]=j,c?(c.innerHTML=j,void 0):j}}}};